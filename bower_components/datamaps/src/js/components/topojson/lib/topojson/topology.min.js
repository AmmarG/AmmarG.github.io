function linesEqual(e,t){var n=e.length,r=-1;if(t.length!==n)return!1;for(;++r<n;)if(e[r]!==t[r])return!1;return!0}function pointCompare(e,t){return e[0]-t[0]||e[1]-t[1]}function noop(){}var type=require("./type"),stitch=require("./stitch-poles"),hashtable=require("./hashtable"),systems=require("./coordinate-systems"),ε=1e-6;module.exports=function(e,t){function n(t){var n=type(t),r={};for(var i in e)r[i]=n.object(e[i])||{};return r}function r(){l=c=-(s=f=1/0),n({point:function(e){var t=e[0],n=e[1];t<s&&(s=t),t>l&&(l=t),n<f&&(f=n),n>c&&(c=n)}})}function i(e){return e.map(o)}function o(e){return u(e,!1)}function a(e){return u(e,!0)}function u(e,t){function n(e,t){var n=e.length;if(t&&!r.length&&1===n){var i=e[0],o=g.get(i);o.length?r.push(o[0]):(r.push(o[0]=z.length),z.push(e))}else if(n>1){var a=e[0],u=e[n-1],s=(i=pointCompare(a,u)<0?a:u,m.get(i));if(s.some(function(t){var i=-1;if(t.length!==n)return!1;for(;++i<n;)if(pointCompare(e[i],t[i]))return!1;return r.push(t.index),!0}))return;if(s.some(function(t){var i=-1;if(t.length!==n)return!1;for(;++i<n;)if(pointCompare(e[i],t[n-i-1]))return!1;return r.push(~t.index),!0}))return;s.push(e),r.push(e.index=z.length),z.push(e)}}var r=[],i=e.length,o=[],a=0;for(t||(e.pop(),--i);a<i;++a){var u=d.peek(e[a]);if(t)break;if(h&&!linesEqual(h,u)){var s=u.every(function(e){return h.indexOf(e)>=0}),f=h.every(function(e){return u.indexOf(e)>=0});s&&!f&&--a;break}h=u}if(a===i&&h.length>1){var l=e[0];for(a=0,c=1;c<i;++c){pointCompare(l,y=e[c])>0&&(l=y,a=c)}}for(var c=0,p=t?i:i+1;c<p;++c){var h,y=e[(c+a)%i];if(!linesEqual(h=d.peek(y),u)){s=u.every(function(e){return h.indexOf(e)>=0}),f=h.every(function(e){return u.indexOf(e)>=0});s&&o.push(y),n(o),s||f||n([o[o.length-1],y]),o=f?[o[o.length-1]]:[]}o.length&&!pointCompare(o[o.length-1],y)||o.push(y),u=h}return n(o,!0),r}var s,f,l,c,p,h,d,m,g,y=1e4,v=function(e){return e.id},b=function(){},x=!0,q=!1,C=0,M=null,z=[];t&&("verbose"in t&&(q=!!t.verbose),"stitch-poles"in t&&(x=!!t["stitch-poles"]),"coordinate-system"in t&&(M=systems[t["coordinate-system"]]),"quantization"in t&&(y=+t.quantization),"id"in t&&(v=t.id),"property-transform"in t&&(b=t["property-transform"])),d=hashtable(10*y),m=hashtable(10*y),g=hashtable(10*y),r();var w=s<-180-ε||l>180+ε||f<-90-ε||c>90+ε;if(M||(M=systems[w?"cartesian":"spherical"],t&&(t["coordinate-system"]=M.name)),M===systems.spherical){if(w)throw new Error("spherical coordinates outside of [±180°, ±90°]");x&&(stitch(e),r()),s<-180+ε&&(s=-180),l>180-ε&&(l=180),f<-90+ε&&(f=-90),c>90-ε&&(c=90)}if(y?(p=l-s?(y-1)/(l-s):1,h=c-f?(y-1)/(c-f):1):(console.warn("quantization: disabled; assuming inputs already quantized"),y=l+1,p=h=1,s=f=0),q){var O=Math.round((s-s)*p)*(1/p)+s,k=Math.round((l-s)*p)*(1/p)+s,E=Math.round((f-f)*h)*(1/h)+f,j=Math.round((c-f)*h)*(1/h)+f;console.warn("quantization: bounds "+[O,E,k,j].join(" ")+" ("+M.name+")")}return n({point:function(e){var t=e[0],n=e[1],r=Math.round((t-s)*p),i=Math.round((n-f)*h),o=M.distance(t,n,r/p+s,i/h+f);o>C&&(C=o),e[0]=r,e[1]=i}}),q&&console.warn("quantization: maximum error "+M.formatDistance(C)),n({line:function(e){for(var t,n=-1,r=e.length;++n<r;)(t=d.get(e[n])).indexOf(e)<0&&t.push(e)}}),e=n({Feature:function(e){var t=e.geometry;return null==e.geometry&&(t={}),"id"in e&&(t.id=e.id),"properties"in e&&(t.properties=e.properties),this.geometry(t)},FeatureCollection:function(e){return e.type="GeometryCollection",e.geometries=e.features.map(this.Feature,this),delete e.features,e},GeometryCollection:function(e){e.geometries=e.geometries.map(this.geometry,this)},MultiPolygon:function(e){e.arcs=e.coordinates.map(i)},Polygon:function(e){e.arcs=e.coordinates.map(o)},MultiLineString:function(e){e.arcs=e.coordinates.map(a)},LineString:function(e){e.arcs=a(e.coordinates)},geometry:function(e){if(null==e?e={}:this.defaults.geometry.call(this,e),e.id=v(e),null==e.id&&delete e.id,t=e.properties){var t,n={};delete e.properties;for(var r in t)b(n,r,t[r])&&(e.properties=n)}return e.arcs&&delete e.coordinates,e}}),d=m=g=null,{type:"Topology",bbox:[s,f,l,c],transform:{scale:[1/p,1/h],translate:[s,f]},objects:e,arcs:z.map(function(e){for(var t,n,r=0,i=e.length,o=e[0],a=o[0],u=o[1],s=[[a,u]];++r<i;)o=e[r],x2=o[0],y2=o[1],t=x2-a,n=y2-u,(t||n)&&(s.push([t,n]),a=x2,u=y2);return s})}};